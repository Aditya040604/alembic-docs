```
async def run_async_migrations() -> None:
    """
    Run migrations in 'online' mode (async).
    """
    connectable = async_engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)

    await connectable.dispose()
```

Ah, now we’re getting into **async online migrations**, Adi. Let’s break this **carefully and clearly**, step by step.

---

# 1️⃣ Purpose of `run_async_migrations`

```python
async def run_async_migrations() -> None:
    """
    Run migrations in 'online' mode (async).
    """
```

- This is **still “online”**, meaning migrations **actually run against a live database**.
    
- The difference: **it uses an asynchronous database engine** (async SQLAlchemy) so it works with `asyncpg` or other async DB drivers.
    
- Useful if your app uses async everywhere (FastAPI, async SQLAlchemy, etc.), so migrations don’t block the event loop.
    

---

# 2️⃣ Create an async engine

```python
connectable = async_engine_from_config(
    config.get_section(config.config_ini_section, {}),
    prefix="sqlalchemy.",
    poolclass=pool.NullPool,
)
```

- `async_engine_from_config(...)` → builds an **async SQLAlchemy engine** using your Alembic config.
    
- Key points:
    
    - Reads all `sqlalchemy.*` options from `alembic.ini` or overridden in `env.py`.
        
    - `poolclass=pool.NullPool` → disables connection pooling (common in migrations to avoid long-lived connections).
        
- Result: `connectable` = **async engine object**, not a live connection yet.
    

---

# 3️⃣ Connect to the database asynchronously

```python
async with connectable.connect() as connection:
    await connection.run_sync(do_run_migrations)
```

Step by step:

1. `async with connectable.connect()` → **opens an async DB connection**.
    
2. `connection.run_sync(do_run_migrations)` → runs the **regular synchronous migration function** (`do_run_migrations`) inside this async connection.
    

- `run_sync()` is a helper:
    
    - Converts a **sync function** (like `do_run_migrations`) to work in an **async engine**.
        
    - Alembic migration logic doesn’t need to be rewritten for async; it runs inside this helper.
        

---

# 4️⃣ Dispose the engine

```python
await connectable.dispose()
```

- Closes the async engine and all connections.
    
- Important to **release DB resources** after migrations finish.
    

---

# 5️⃣ Flow of execution

```
async def run_async_migrations()
        │
        ▼
async_engine_from_config() → create async engine
        │
        ▼
async with connectable.connect() as connection → open live connection
        │
        ▼
await connection.run_sync(do_run_migrations) → run migrations online
        │
        ▼
await connectable.dispose() → close engine
```

- **Database is updated in real-time** (online mode).
    
- Everything happens asynchronously, so it **doesn’t block an async event loop**.
    

---

# 6️⃣ Comparison Table

|Function|Mode|Sync/Async|DB Connection|Executes SQL?|
|---|---|---|---|---|
|`run_migrations_offline()`|Offline|Sync|❌ No|❌ Only generates SQL|
|`do_run_migrations()`|Online|Sync|✅ Yes|✅ Executes SQL|
|`run_async_migrations()`|Online|Async|✅ Yes (async engine)|✅ Executes SQL|

---

# 7️⃣ Analogy

- `do_run_migrations()` → a **chef in the kitchen** cooking synchronously.
    
- `run_async_migrations()` → **multiple chefs working asynchronously**, but still cooking in the real kitchen (DB).
    
- Offline → writing the recipe on paper, not touching the kitchen.
    

---

✅ **Key takeaway**:

- `run_async_migrations()` is **just the async version of online migration**.
    
- Uses `async_engine_from_config` + `run_sync()` so **your existing migration logic works with async DB drivers**.
    
- Database schema is updated in real-time.
    

---

If you want, I can **draw a diagram showing offline → online sync → online async migrations with connections and execution flow**. It’s super intuitive visually.

Do you want me to make that?